---
title: "ANÁLISE ESTATÍSTICA MULTIVARIADA"
author: "João Ricardo F. de Lima"
date: "today"
editor: source
lang: pt
language: 
  toc-title-document: '<a href="https://www.facape.br/" target="_blank"><img src="https://github.com/econfacape/macroeconometria/blob/main/logofacape.jpg?raw=true" alt="Logotipo Facape" width="150"></a>'
format: 
  html:
    toc: true
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    toc-location: left
    code-fold: false
    embed-resources: true
    page-layout: full
    fig-asp: 0.618
    fig-width: 8
    fig-height: 5
    fig-dpi: 300
    fig-align: center
    df-print: paged
    fontsize: 13pt
theme:
  light: flatly
execute:
  echo: TRUE
  message: false
  warning: false
---

<hr>



# Conceito, Objetivos e Dados



Consiste em um conjunto de métodos estatísticos usados para simplificar a interpretação de grandes conjuntos de dados. A aplicação pode ocorrer em diversas áreas do conhecimento.

Segundo Mingoti (2005, p. 21), *"embora historicamente o uso de métodos multivariados esteja relacionado com trabalhos na Psicologia, Ciências Sociais e Biológicas, mais recentemente eles têm sido aplicados em um grande universo de área diferentes, como: Educação, Geologia, Química, Física, Engenharia, Ergonomia, etc."*.

Basicamente os **objetivos** são:

a) Redução ou simplificação da base de dados sem sacrificar informação importante;
 
b) Ordenação e agrupamento (classificação) - criar grupos de objetos (ou variáveis) semelhantes com base em várias características. Por isso é multivariada;

c) Investigação da estrutura de dependência entre as variáveis. Podemos ter um conjunto de dados relacionados com tecnologias utilizadas nas fazendas e outro conjunto de dados relacionados com característica do dono da propriedade. A dependência entre estes grupos de variáveis pode indicar porque algumas propriedades usam mais tecnologias do que outras;

d) Predição - realizar previsões;
 
e) Construção de hipóteses e testes.

As técnicas de Análise multivariada são muito utilizadas para a construção de índices. Um índice sintetiza em uma única variável a informação de todas as variáveis que foram medidas sobre o fenômeno. Como exemplo, pode-se citar Índice de Desemprego, Índice de Qualidade de Vida, Índice de Qualidade Ambiental, Índice de Desenvolvimento Humano (IDH), entre outros. Nestes casos, a *Análise de Componentes Principais* ou *Análise Fatorial* são técnicas que podem ser utilizadas (LIMA, 2015). 

Outra aplicação interessante é quando se procura dividir um conjunto de objetos em grupos que sejam os mais homogêneos possíveis dentro do grupo e heterogêneos entre si. Uma empresa pode buscar estratificar seus clientes, dividindo-os em grupos e traçando objetivos para cada grupo separadamente. Pode-se separar os municípios de determinado estado em grupos homogêneos com o intuito de delinear programas adequados para os diferentes grupos. Nestes casos, a *Análise de Cluster* é a técnica adequada (LIMA, 2015). 

Outra situação é a enfrentada pelas seguradoras para realização de seguros de veículos. Cada cliente se encaixa em determinado perfil que pode ter maior ou menor risco de sinistro. Neste caso, pode-se aplicar *Análise Discriminante* buscando identificar a qual grupo de risco de sinistro um determinado elemento tem mais chance de pertencer (LIMA, 2015).

Os **dados para Análise multivariada** em uma amostra de seção cruzada são geralmente compostos de variáveis (renda, idade, anos de escolaridade, etc.) e observações (pessoa, família, escola, município, estado, país, etc.). Dispostos em uma tabela os dados formam uma matriz em que cada coluna se refere a uma variável e cada linha a uma observação. As **observações** são as unidades de Análise ou unidades amostrais e as **variáveis** são as características medidas nas observações. Assim, os dados usados são tipicamente formados por *n* observações em *p* variáveis.

```  {r estat1, warning=FALSE, message=FALSE}
#Verificando o diretorio que o R esta direcionado
getwd()

#Direcionado o R para o Diretorio a ser trabalhado
setwd('/Users/jricardofl/Dropbox/tempecon/dados_censoagro')

#Pacote
library(readxl)

#Entrada dos dados
dados <- read_excel("artigo.xlsx")

# Nomes das variáveis utilizadas
#
#x1	Porcentagem dos estabelecimentos que usam força animal
#x2	Porcentagem dos estabelecimentos que usam força mecânica
#x3	Porcentagem da área com pastagens que é plantada
#x5	area trabalhada como porcentagem da área aproveitável
#x6	Area com lavouras permanentes e temporárias como proporção da área aproveitável
#x7	Numero de tratores por equivalente homem
#x8	Numero de tratores por área explorada
#x9	Numero de arados por área explorada
#x10	Numero de colheitadeiras por área explorada
#x11	Valor total dos combustíveis consumidos por área explorada
#x12	Quantidade de energia eletrica consumida por área explorada
#x13	Quantidade de energia eletrica consumida po equivalente homem
#x14	Valor total dos bens por área explorada
#x15	Valor total dos bens por equivalente homem
#x16	valor total dos investimentos por area explorada
#x17	Valor total dos investimentos por equivalente homem
#x18	Valor total dos financiamentos em 2006 por área explorada
#x19	Valor total dos financiamentos em 2006 por equivalente homem.
#x20	Valor total da produção em 2006, por área explorada
#x21	Valor total da produção em 2006, por equivalente-homem
#x22	Valor total das despesas em 2006, por área explorada
#x23	Valor total das despesas em 2006, por equivalente homem
#x24	Despesas com adubos, corretivos, sementes e mudas, agrotóxicos, medicamenteos para animais, sal e rações por área explorada
#x25	Despesas com adubos, corretivos, sementes e mudas, agrotóxicos, medicamenteos para animais, sal e rações por equivalente homem
#x26	Assistência Técnica
#x27	uso de agrotóxico para controle de pragas e doenças
#x28	uso de controle alternativo de pragas e doenças
#x29	irrigação

#Visualizaçao dos dados
round(head(dados, 15),1)

summary(dados)
```



# Técnicas da Análise Multivariada



Pode-se considerar que a estatística multivariada se divide em dois grupos: o primeiro consiste nas técnicas de simplificação da estrutura de variabilidade dos dados. Principalmente, fazem parte deste grupo a **Análise de Componentes Principais, Análise Fatorial, Correlações Canônicas, Cluster e Discriminante**.
	
O segundo grupo concentra os métodos de estimação de parâmetros, como na análise de **Regressão Simples** e **Múltipla**. 

Para um estudo aprofundado das técnicas de *Análise Multivariada*, é importante revisar conceitos de Estatística Básica: média, variância, desvio padrão, covariância, correlação seriam as mais relevantes.

E também é importante revisar conceitos de álgebra matricial: vetores, matrizes, combinações lineares, dependência linear, raízes e vetores característicos e decomposição espectral, basicamente. 



## Análise de Componentes Principais



A Análise de Componentes Principais (ACP) é uma técnica de Análise Multivariada que consiste em transformar um conjunto original de variáveis em outro conjunto, os Componentes Principais (CP) com propriedades específicas. Os CP’s são combinações lineares das variáveis originais e são estimados de forma a captar o máximo da variação total dos dados. O processo de estimação é tal que o primeiro CP capta o máximo de variância possível, o segundo capta o máximo possível do restante de variância, o terceiro o máximo possível do restante de variância, e assim sucessivamente.

A ACP é apropriada quando as variáveis sob investigação são todas de mesma natureza, de modo que não tenhamos, por exemplo, uma ou mais variáveis dependentes e um conjunto de covariáveis, como no caso de análise de regressão.

Segundo Mingoti (2005, p. 59), *"seu objetivo principal é o de explicar a estrutura de variância-covariância de um vetor aleatório, composto de p-variáveis aleatórias, através da construção de combinações lineares das variáveis originais. Estas combinações lineares são chamadas de componentes principais e são não correlacionadas entre si"*.

Uma combinação linear de vetores ou de variáveis é um novo vetor (ou nova variável) defindo por 

$$
y=a_1x_1+a_2x_2+a_3x_3+ \dots + a_px_p
$$
*"Se temos p-variáveis originais é possível obter-se p componentes principais. No entanto, em geral deseja-se obter 'redução do número de variáveis a serem avaliadas e interpretação das combinações lineares construídas', ou seja, a informação contida nas p-variáveis originais é substituída pela informação contida em k (k$<$p) componentes principais não correlacionados"* (MINGOTI, 2005, p. 59).

A ideia é que se algumas das variáveis originais são correlacionadas, elas estão, efetivamente, “dizendo a mesma coisa”. Nesse caso, um conjunto menor de variáveis, não-correlacionadas, pode ser tão eficaz quanto o conjunto de variáveis originais para explicar a estrutura de variância-covariância dos dados.

Matricialmente, pode ser escrita como $y=a'x$ onde os a's são as constantes que definem a combinação linear e são determinadas de forma a atender às características da combinação linear que se deseja. Como as variáveis são dadas, os coeficientes a's são determinados de forma a atender às restrições estabelecidas, ou seja, o princípio da técnica. As combinações lineares tem média e variância definidas, respectivamente, por $E(Y)=a'\mu$ e $V(Y)=a'\sum a$. 

Mais de uma combinação linear pode ser definida de um conjunto de variáveis. Em geral, com *p* variáveis pode-se formar p combinaçoes lineares diferentes. 

A ACP transforma um conjunto de variáveis correlacionadas em um conjunto de variáveis não-correlacionadas. Assim, se as variáveis originais são aproximadamente não correlacionadas, não faz sentido ser feita uma ACP.

Variáveis quantitativas usadas em análise multivariada são, geralmente, expressas em unidades diferentes. Diferenças de escalas afetam a contribuição da variável para a variância generalizada. Para usar essas variáveis em uma técnica multivariada elas precisam ser transformadas para uma escala comum. Entre os métodos usados alguns eliminam diferenças em tamanho (escala) outras reduzem tamanho e variabilidade para uma escala comum.

O método mais usado para tornar variáveis comparáveis é a *Padronização*, que consiste em subtrair a média e dividir pelo desvio padrão. Além de simplificar cálculos e manipulações matemáticas, a padronização de variáveis é importante para resolver o problema de unidades de medidas diferentes das variáveis e do desbalanceamento entre as variâncias. Toda variável padronizada tem média zero, variância igual a um e é adimensional. 

Uma questão importante é que a covariância entre variáveis padronizadas é igual a correlação entre variáveis originais. Assim, usar a matriz de correlações das variáveis ao invés da matriz var-cov é o mesmo que trabalhar com variáveis padronizadas. 

Existe uma tendência para que a variável com maior volatilidade cause uma desestabilização na Análise de Componentes Principais e também na Análise Fatorial. A solução é padronizar as variáveis de forma que tenham média zero e variância unitária.

A Análise passa a ser determinar as *raízes características* e os *vetores característicos* da matriz de correlações. 

Sobre raízes e vetores característicos, uma matriz quadrada A tem raízes características $\lambda_i$ e vetores característicos $X_i$ dados pela seguinte relação $AX=\lambda X$. Uma matriz $p_xp$ tem *p* raízes e *p* vetores característicos e a relação pode ser escrita como $AX_i=\lambda_i X_i$ o que, intituitivamente, significa que existem constantes $\lambda_i$ e vetores $X_i$, tais que a multiplicação da matriz pelo vetor é igual à multiplicação do vetor por uma constante. 

As raízes e vetores característicos são encontrados a partir de 

$$
AX=\lambda X
$$

$$
AX - \lambda X= 0
$$
$$
(A- \lambda I)X= 0
$$

sendo que a equação é verdadeira para qualquer $\lambda$ se $X=0$, mas esta solução não interessa. Para se ter uma solução $X \neq 0$, a inversa da equação característica $(A- \lambda I)$ não deve existir e, para isto, o seu determinante precisa ser igual a zero. Assim, pode-se entender $\lambda$ (raízes características) como os valores que zeram o determinante da equação característica.

Os vetores característicos não são únicos, devendo ser normalizados. Para cada raiz característica existe um vetor característico que é encontrado resolvendo a expressão $(A-\lambda_i I)X_i=0$. 

As raízes características possuem um conjunto de propriedades: 

1) $tr(A) =  \sum_{i=1}^{p} \lambda_i$;
2) $det(A) = \Pi_{i=1}^{p}$. Se alguma raiz característica for zero, o determinante de A é zero e a matriz não possui inversa; 
3) Para uma matriz diagonal, as raízes são os elementos da diagonal principal;
4) Para uma matriz triangular, as raízes são os elementos da diagonal principal;
5) Raízes de A são iguais as de $A'$;
6) As raízes de $A^{-1}$ são iguais a $1/ \lambda_i$, mas os vetores característicos são os mesmos;
7) Se A é ortogonal, $\lambda_i=1$ ou $-1$;
8) Se A é uma matriz idempotente, $\lambda_i=1$ ou $0$;
9) Raízes características de matrizes simétrica são números reais;
10) Os vetores característicos de matrizes simétricas são ortogonais, ou seja, não
correlacionados.



### Obtenção dos Componentes Principais



Considere um vetor de p variáveis padronizadas dada por

$$
\mathbf{Z'}=\left[\begin{array}{llll}
Z_1 &Z_2 &\dots &Z_p
\end{array}\right]
$$
os CP's são combinações lineares dos $Z's$

$$
Y_j=a'_jZ=a_{j1}Z_1+a_{j2}Z_2+\dots+a_{jp}Z_p
$$

sendo que é possível ter até *p* CP's, com o primeiro tendo a maior variância, o segundo CP tendo a segunda maior variância e sendo ortogonal ao primeiro, etc. Neste caso, a variância de $Z_i$ é dada por $V(Z_i)=a_i'\sum a_i$ e o que deve ser feito é encontrar os coeficientes de $a_i$ das combinaçoes lineares de forma a satisfazer as condições acima definidas. 

É possível demonstrar (LIMA, 2015) que a solução se resume em encontrar as raízes características $(\lambda_i)$ e os vetores característicos $(a_i)$ da matriz var-cov $(\sum)$ das variáveis. Os coeficientes dos CP's são os elementos dos vetores característicos $(a_i)$. 

Além disso, é possível demonstrar que $\sum a_i= \lambda a_i$ e, consequentemente, 

$$
V(Z_i)=a_i'\sum a_i = a_i'\lambda a_i = \lambda a_i'a_i 
$$

e que a $V(Z_i) = \lambda _i$ pois pela ortogonalidade $a_i'a_i =1$ ($a_i'a_i=\sum_{p=1}^ja_{jp}^2$), o que significa que a variância do componente i é igual a sua raiz característica. 

Finalmente, dado que $a_i'a_k =0$, a covariância entre os CP's é igual a zero, ou seja, não são correlacionados, são ortogonais. 

Como dito anteriormente, com *p* variáveis é possível ter até *p* CP's. Assim, a variância total dos *p* componentes tem que ser igual a variância total das variáveis Z. 

A importância relativa de cada componente é dada pelo percentual de sua variância em relação à variância total, ou seja, é a variância explicada ou captada por ele. Assim, a importância relativa de $Z_k$ é dada por $( \lambda_k / \sum_{i}^{p} \lambda_i)100$. Se um, dois ou três componentes captam grande parcela da variância dos dados, pode-se concentrar a análise neste número menor de variáveis.

Como a idéia da ACP é redução da massa de dados para uma dimensão mais adequada para análise, se faz necessário decidir quantos CP’s usar. Com p variáveis deve-se manter k componentes, sendo $k<q$. A determinação de k não é uma decisão estatística porque não se tem um modelo adequado para tal e por isso é feita de forma prática. Utiliza-se os seguintes critérios:

a) Dada a importância relativa de cada componente, manter o número de componentes que captam "certa" percentagem da variância dos dados, com $70\%$ sendo um valor de referência;

b) Desconsiderar os componentes com variância inferior à variância média das variáveis originais.



### Interpretação dos Coeficientes do Componente Principal



Os coeficientes dos componentes indicam a importância da variável para o componente. Isto possibilita atribuir um significado ao componente. Além do coeficiente pode-se calcular a correlação entre o componente e a variável. A correlação entre $Y_j$ e a variável padronizada $Z_i$ é igual a:

$$
r_{Y_i,Z_k}=\frac{a_{ik}}{\sqrt{\sigma_k^2}}\sqrt{\lambda_i}
$$
e, então, as variáveis $\mathbf{Z}$ com os maiores coeficientes na componente principal $\mathbf{Y_j}$ são as mais correlacionadas com a componente. A matriz de correlações entre as variáveis e os componentes é bastante
importante para entender os componentes e lhes atribuir um nome. É possível também testar a significância estatística de cada peso ou coeficiente do componente. A hipótese nula é de que o coeficiente é estatisticamente igual a zero.



### Análise de Componentes Principais - Escores



Escore é o valor de $\mathbf{Y_i}$ para cada observação. Estes servem para, por exemplo:

I) comparar ou ordenar as observações; 
II) Análise de cluster ou regressão.



### Demonstração de ACP no R



```  {r estat2, warning=FALSE, message=FALSE}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('/Users/jricardofl/Dropbox/tempecon/multivariada')

#Lendo os dados no R
library(car)
library(tidyverse)
library(corrplot)
library(graphics)
library(ade4)
library(grid)
library(MVar.pt)
library(factoextra)

data(mtcars)

#Format
#A data frame with 32 observations on 11 (numeric) variables.

#[, 1] mpg Milhas/(EUA) galão
#[, 2] cil Número de cilindros
#[, 3] disp Cilindradas cc
#[, 4] HP Potência bruta
#[, 5] drat Relação do eixo traseiro
#[, 6] Peso em peso (1000 lbs)
#[, 7] qsex tempo 1/4 de milha
#[, 8] vs Motor (0 = em forma de V, 1 = reto)
#[, 9] am Transmissão (0 = automática, 1 = manual)
#[,10] gear Número de marchas para frente
#[,11] carb Número de carburadores

# Criando um objeto
dados <- mtcars
summary(dados) # estatística descritiva dos dados

# Retirando as variáveis binárias
dados <- mtcars |>
  dplyr::select(-vs, -am)

# Verificação da estrutura dos dados
glimpse(dados)
head(dados)
tail(dados)

# ESTIMACAO DAS ESTATISTICAS DESCRITIVAS E CALCULO DA MATRIZ DE CORRELAÇOES
summary(dados) #sem as variáveis binárias
desvpad <- sapply(dados, sd) #para calcular o desvio-padrao
round(desvpad,2)
cov(dados) #covariância

# Matriz de Correlacoes
matcor <- cor(dados)
print(matcor, digits=4)
corrplot(cor(dados), order="hclust", tl.col="black", tl.cex = .75)

#Análise de componentes principais - dados devem ser padronizados
#Padronizacao dos dados
dados.pad <- as.data.frame(scale(dados))

#Analise de Componentes principais com prcomp
resultados.pca <- prcomp(dados.pad, scale = TRUE) #ACP

#Raizes Caracteristicas - 1 Forma
(resultados.pca$sdev)^2

summary(resultados.pca)

sum((resultados.pca$sdev)^2) #traco da matriz

#É possivel escolher o número de CP com base no Autovalor >1
(resultados.pca$sdev^2)

# Gráfico do percentual de variância explicada
screeplot(resultados.pca, type="lines")
fviz_eig(resultados.pca)
```

Se observa que 62,84% da variabilidade total dos dados são explicados pela primeira componente
principal. Além disso, a segunda componente principal explica 23,13% da variação total. As duas primeiras componentes principais explicam juntas 85,98% da variabilidade total dos dados. 

```  {r estat3, warning=FALSE, message=FALSE}
#Resultados das combinações lineares
resultados.pca

#Escores para cada observação
resultados.pca$x # valores das componentes principais

#Correlaçoes entre as variaveis e os escores
cor(dados, resultados.pca$x)
```

### Análise Gráfica da ACP

```  {r estat4, warning=FALSE, message=FALSE}
fviz_pca_ind(resultados.pca,
             col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             legend.title = "Representation")

fviz_pca_var(resultados.pca, 
             col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             legend.title = "Contribution")

fviz_pca_biplot(resultados.pca, 
                repel = TRUE, 
                col.var = "#2E9FDF", 
                col.ind = "#696969")

dados <- mtcars %>% mutate(
  am = case_when(am == 0 ~ "Automatic", 
                 TRUE ~ "Manual"))

fviz_pca_ind(resultados.pca, 
            col.ind = dados$am, 
             palette = c("#00AFBB", "#FC4E07"), 
             addEllipses = TRUE, 
             legend.title = "Engine shape", 
             repel = TRUE)

fviz_pca_biplot(resultados.pca, 
                repel = TRUE, 
                col.var = "black", 
                col.ind = as.factor(dados$am), 
                addEllipses = TRUE, 
                legend.title = "Transmissão")
```
